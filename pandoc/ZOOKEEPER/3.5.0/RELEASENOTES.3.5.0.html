<!---
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
-->
<h1 id="apache-zookeeper-3.5.0-release-notes">Apache Zookeeper 3.5.0 Release Notes</h1>
<p>These release notes cover new developer and user-facing incompatibilities, important issues, features, and major improvements.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1972">ZOOKEEPER-1972</a> | <em>Major</em> | <strong>Fix invalid volatile long/int increment (++)</strong></li>
</ul>
<p>Awesome! thanks Hongchao! Committed to trunk</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1835">ZOOKEEPER-1835</a> | <em>Major</em> | <strong>dynamic configuration file renaming fails on Windows</strong></li>
</ul>
<p>Patch described in this comment below: https://issues.apache.org/jira/browse/ZOOKEEPER-1835?focusedCommentId=13848420&amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13848420</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1819">ZOOKEEPER-1819</a> | <em>Minor</em> | <strong>DeserializationPerfTest calls method with wrong arguments</strong></li>
</ul>
<p>Fix DeserializationPerfTest which was not testing the desired scenarios.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1812">ZOOKEEPER-1812</a> | <em>Minor</em> | <strong>ZooInspector reconnection always fails if first connection fails</strong></li>
</ul>
<p>Fixed ZooInspector reconnection</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1811">ZOOKEEPER-1811</a> | <em>Major</em> | <strong>The ZooKeeperSaslClient service name principal is hardcoded to &quot;zookeeper&quot;</strong></li>
</ul>
<p>Adds a new system property &quot;zookeeper.sasl.client.username&quot; that can be used to configure the ZK Kerberos (SASL) client user principal name to something other than &quot;zookeeper&quot; (default) for any environments that use non-standard naming for its principals.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1771">ZOOKEEPER-1771</a> | <em>Minor</em> | <strong>ZooInspector authentication</strong></li>
</ul>
<p>Added authentication for ZooInspector.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1718">ZOOKEEPER-1718</a> | <em>Critical</em> | <strong>Support JLine 2</strong></li>
</ul>
<p>JLine upgraded to version 2.11</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1666">ZOOKEEPER-1666</a> | <em>Major</em> | <strong>Avoid Reverse DNS lookup if the hostname in connection string is literal IP address.</strong></li>
</ul>
<p>Try to avoid reverse name service look up when the connection string consists of literal IP addresses but not real host names.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1632">ZOOKEEPER-1632</a> | <em>Minor</em> | <strong>fix memory leaks in cli_st</strong></li>
</ul>
<p>The fix for this issue solves the memory leak spotted in the absence of errors. In the case the completion function is not registered because of an error (e.g., see zoo_async), the line duplicate won't be freed.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1562">ZOOKEEPER-1562</a> | <em>Trivial</em> | <strong>Memory leaks in zoo_multi API</strong></li>
</ul>
<p>zoo_multi API used to leak memory while deserializing the response from zookeeper server. Completion entries for individual operation in zoo_multi transaction weren't getting cleaned causing memory leak. This patch resolves this memory leak by destroying completion entries in deserialize_multi function.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1557">ZOOKEEPER-1557</a> | <em>Major</em> | <strong>jenkins jdk7 test failure in testBadSaslAuthNotifiesWatch</strong></li>
</ul>
<p>Committed to 3.4.6/trunk. Thanks Eugene.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1509">ZOOKEEPER-1509</a> | <em>Major</em> | <strong>Please update documentation to reflect updated FreeBSD support.</strong></li>
</ul>
<p>Update documentation to reflect full FreeBSD support.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1506">ZOOKEEPER-1506</a> | <em>Blocker</em> | <strong>Re-try DNS hostname -&gt; IP resolution if node connection fails</strong></li>
</ul>
<p>Tests pass with this patch. This patch is for the branch-3.4 branch ONLY.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1459">ZOOKEEPER-1459</a> | <em>Major</em> | <strong>Standalone ZooKeeperServer is not closing the transaction log files on shutdown</strong></li>
</ul>
<p><strong>WARNING: No release note provided for this incompatible change.</strong></p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1408">ZOOKEEPER-1408</a> | <em>Minor</em> | <strong>CLI: sort output of ls command</strong></li>
</ul>
<p>The output of ls-command in CLI does not contain the []-frame any more. Instead the nodes are sorted.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1367">ZOOKEEPER-1367</a> | <em>Blocker</em> | <strong>Data inconsistencies and unexpired ephemeral nodes after cluster restart</strong></li>
</ul>
<p>Fix Data inconsistencies and unexpired ephemeral nodes after cluster restart.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1344">ZOOKEEPER-1344</a> | <em>Critical</em> | <strong>ZooKeeper client multi-update command is not considering the Chroot request</strong></li>
</ul>
<p><strong>WARNING: No release note provided for this incompatible change.</strong></p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1340">ZOOKEEPER-1340</a> | <em>Major</em> | <strong>multi problem - typical user operations are generating ERROR level messages in the server</strong></li>
</ul>
<p>Unwanted ERROR messages in the logs.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1336">ZOOKEEPER-1336</a> | <em>Major</em> | <strong>javadoc for multi is confusing, references functionality that doesn't seem to exist</strong></li>
</ul>
<p>Improved Javadoc for multi API's.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1327">ZOOKEEPER-1327</a> | <em>Major</em> | <strong>there are still remnants of hadoop urls</strong></li>
</ul>
<p>Remove links to Hadoop wiki's in ZooKeeper docs.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1322">ZOOKEEPER-1322</a> | <em>Major</em> | <strong>Cleanup/fix logging in Quorum code.</strong></li>
</ul>
<p>Improved logging in Quorum Code.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1305">ZOOKEEPER-1305</a> | <em>Major</em> | <strong>zookeeper.c:prepend_string func can dereference null ptr</strong></li>
</ul>
<p>return ZBADARGUMENTS when passed NULL zhandle instead of dereferencing null pointer.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1294">ZOOKEEPER-1294</a> | <em>Major</em> | <strong>One of the zookeeper server is not accepting any requests</strong></li>
</ul>
<p><strong>WARNING: No release note provided for this incompatible change.</strong></p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1291">ZOOKEEPER-1291</a> | <em>Major</em> | <strong>AcceptedEpoch not updated at leader before it proposes the epoch to followers</strong></li>
</ul>
<p>Revision 1198053</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1282">ZOOKEEPER-1282</a> | <em>Major</em> | <strong>Learner.java not following Zab 1.0 protocol - setCurrentEpoch should be done upon receipt of NEWLEADER (before acking it) and not upon receipt of UPTODATE</strong></li>
</ul>
<p>Revision 1198053</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1277">ZOOKEEPER-1277</a> | <em>Critical</em> | <strong>servers stop serving when lower 32bits of zxid roll over</strong></li>
</ul>
<p>Workaround: there is a simple workaround for this issue. Force a leader re-election before the lower 32bits reach 0xffffffff</p>
<p>Most users won't even see this given the number of writes on a typical installation - say you are doing 500 writes/second, you'd see this after ~3 months if the quorum is stable, any changes (such as upgrading the server software) would cause the xid to be reset, thereby staving off this issue for another period.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1264">ZOOKEEPER-1264</a> | <em>Blocker</em> | <strong>FollowerResyncConcurrencyTest failing intermittently</strong></li>
</ul>
<p>Revision 1198053</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1263">ZOOKEEPER-1263</a> | <em>Major</em> | <strong>fix handling of min/max session timeout value initialization</strong></li>
</ul>
<p>trunk: http://svn.apache.org/viewvc?view=revision&amp;revision=1581522</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1262">ZOOKEEPER-1262</a> | <em>Major</em> | <strong>Documentation for Lock recipe has major flaw</strong></li>
</ul>
<p>Updated recipes to document how to use a GUID to manage a recoverable create() error.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1239">ZOOKEEPER-1239</a> | <em>Major</em> | <strong>add logging/stats to identify fsync stalls</strong></li>
</ul>
<p>committed to 3.3.4, 3.4, trunk rev 1202360</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1208">ZOOKEEPER-1208</a> | <em>Blocker</em> | <strong>Ephemeral node not removed after the client session is long gone</strong></li>
</ul>
<p>trunk version 1201832</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1189">ZOOKEEPER-1189</a> | <em>Major</em> | <strong>For an invalid snapshot file(less than 10bytes size) RandomAccessFile stream is leaking.</strong></li>
</ul>
<p><strong>WARNING: No release note provided for this incompatible change.</strong></p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1185">ZOOKEEPER-1185</a> | <em>Major</em> | <strong>Send AuthFailed event to client if SASL authentication fails</strong></li>
</ul>
<p>This patch fixes SaslAuthFailTest.testBadSaslAuthNotifiesWatch() to test for the AuthFailed event : previously, the test was incorrectly not testing for this event.</p>
<p>It also removes the testBadSaslAuthNotifiesWatch() method from the SaslAuthTest class : this method belongs in SaslAuthFailTest, not SaslAuthTest. The former tests unsuccessful SASL authentication; the latter, successful SASL authentication.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1181">ZOOKEEPER-1181</a> | <em>Major</em> | <strong>Fix problems with Kerberos TGT renewal</strong></li>
</ul>
<p>-Fixes two findbugs warnings related to holding a lock while sleeping. -Addresses Camille's point: merge two almost-identical retry methods into a single retry method.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1179">ZOOKEEPER-1179</a> | <em>Critical</em> | <strong>NettyServerCnxn does not properly close socket on 4 letter word requests</strong></li>
</ul>
<p>Thanks Rakesh, you are right, this error is not happening anymore. Flavio, I'm closing this.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1149">ZOOKEEPER-1149</a> | <em>Blocker</em> | <strong>users cannot migrate from 3.4-&gt;3.3-&gt;3.4 server code against a single datadir</strong></li>
</ul>
<p>The ZooKeeper server cannot be migrated from version 3.4 to version 3.3 and then back to version 3.4 without user intervention.</p>
<p>Upgrading from 3.3 to 3.4 is supported as is downgrading from 3.4 to 3.3. However moving from 3.4 to 3.3 and back to 3.4 will fail. 3.4 is checking the datadir for &quot;acceptedEpoch&quot; and &quot;currentEpoch&quot; files and comparing these against the snapshot and log files contained in the same directory. These epoch files are new in 3.4.</p>
<p>As a result: 1) upgrading from 3.3 to 3.4 is fine - the files don't exist, the server creates them 2) downgrading from 3.4 to 3.3 - this is also fine as version 3.3 ignores these files 3) however, 3.4-&gt;3.3-&gt;3.4 fails because 3.4 will see invalid *Epoch files in the datadir (as 3.3 would have ignored them, applying changes to snap/log w/o updating them)</p>
<p>A workaround for this problem is to delete the epoch files if this situation occurrs - the version 3.4 server will create them similar to case 1) above.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1100">ZOOKEEPER-1100</a> | <em>Major</em> | <strong>Killed (or missing) SendThread will cause hanging threads</strong></li>
</ul>
<p><strong>WARNING: No release note provided for this incompatible change.</strong></p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1062">ZOOKEEPER-1062</a> | <em>Major</em> | <strong>Net-ZooKeeper: Net::ZooKeeper consumes 100% cpu on wait</strong></li>
</ul>
<p>Cosmetic fixes to the patch</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-732">ZOOKEEPER-732</a> | <em>Minor</em> | <strong>Improper translation of error into Python exception</strong></li>
</ul>
<p>Client that uses python binding may receive SystemError on session expiration.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-271">ZOOKEEPER-271</a> | <em>Minor</em> | <strong>Better command line parsing in ZookeeperMain.</strong></li>
</ul>
<p>There are three incompatibilities introduced by this commit into the client shell:</p>
<p>1) now requires commons-cli 2) get no longer returns stat information by default, however there is a &quot;-s&quot; option that will result in the stat being included 3) a deprecated message is reported in some cases, when the old command format is used. As a result the output of the command may be different compared to client output prior to this change.</p>
<hr />
<ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-87">ZOOKEEPER-87</a> | <em>Critical</em> | <strong>Follower does not shut itself down if its too far behind the leader.</strong></li>
</ul>
<p>The value of syncLimit should be reviewed before this change is introduced in the cluster. Since it now detects followers that are lagging behind, clusters in which this was happening will now see followers being disconnected from time to time. This will normally be solved by increasing the syncLimit value.</p>
